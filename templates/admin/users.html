{% extends 'web/base.html' %}
{% load static %}

{% block title %}Home - My Website{% endblock %}

{% block content %}
<body>
  <div class="container">
    <h2>User List</h2>
    <div class="form-group">
      <form id="search-form">
        <input type="text" id="search-input" class="form-control" placeholder="Search by email">
      </form>
    </div>
    <table id="user-table" class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Email</th>
          <th>User Hash</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Created At</th>
          <th>Updated At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="user-table-body">
        {% for user in users %}
        <tr>
          <td>{{ user.id }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.userHash }}</td>
          <td>{{ user.first_name }}</td>
          <td>{{ user.last_name }}</td>
          <td>{{ user.created_at }}</td>
          <td>{{ user.updated_at }}</td>
          <td>
            <a href="{% url 'home' %}" class="btn btn-sm btn-primary">Edit</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function() {
      // Function to fetch users based on search query
      function searchUsers(query) {
        $.ajax({
          url: "{% url 'search-users' %}",
          type: "GET",
          data: {
            q: query
          },
          success: function(response) {
            // Clear the table body
            $('#user-table-body').empty();

            // Iterate through the retrieved users and add them to the table
            response.users.forEach(function(user) {
              var row = $('<tr>');
              row.append($('<td>').text(user.id));
              row.append($('<td>').text(user.email));
              row.append($('<td>').text(user.userHash));
              row.append($('<td>').text(user.first_name));
              row.append($('<td>').text(user.last_name));
              row.append($('<td>').text(user.created_at));
              row.append($('<td>').text(user.updated_at));
              row.append($('<td>').html('<a href="{% url "edit-user" user.id %}" class="btn btn-sm btn-primary">Edit</a>')); 
              $('#user-table-body').append(row);
            });
          },
          error: function(xhr) {
            console.log(xhr.responseText);
          }
        });
      }

      // Listen for form submit event
      $('#search-form').submit(function(e) {
        e.preventDefault(); // Prevent the form from submitting

        var query = $('#search-input').val();
        searchUsers(query);
      });

      // Listen for keyup event on the search input
      $('#search-input').keyup(function() {
        var query = $(this).val();
        searchUsers(query);
      });
    });
  </script>
</body>
{% endblock %}